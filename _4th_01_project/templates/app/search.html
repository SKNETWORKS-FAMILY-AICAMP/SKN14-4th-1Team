{% extends "layout/base.html" %}
{% load static %}

{% block title %}ì˜ì–‘ì œ ê²€ìƒ‰í•˜ê¸° Â· NutriWise{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/search.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block content %}
<section class="container-fluid py-4">
  <div class="main-container w-100 text-center mx-auto" >
    <div class="page-header">
      <h1><i class="fas fa-search me-3"></i><strong>ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ ê²€ìƒ‰í•˜ê¸°</strong></h1>
      <p class="lead mb-0">ì œí’ˆëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì—¬ ê²€ìƒ‰í•´ë³´ì„¸ìš”</p>
    </div>

    <!-- ê²€ìƒ‰ í¼ -->
    <form method="post" enctype="multipart/form-data" class="d-flex justify-content-center align-items-center gap-2 mb-4 mt-4" id="searchForm">
      {% csrf_token %}
      <input type="text" name="q" class="search-input" placeholder="ì œí’ˆëª… / ì„±ë¶„ / ë¸Œëœë“œë¡œ ê²€ìƒ‰" value="{{ request.POST.q }}" id="searchInput">

      <label class="camera-btn" title="ì´ë¯¸ì§€ ì—…ë¡œë“œ">
        <input type="file" name="image" id="image" class="d-none" accept="image/*" onchange="this.form.submit()">
        <i class="bi bi-camera"></i>
      </label>

      <button type="submit" class="btn-search">
        <i class="bi bi-search"></i>
        ê²€ìƒ‰
      </button>
    </form>

    <!-- ë¡œë”© í‘œì‹œ -->
    <div id="loading-indicator" class="text-center my-3" style="display: none;">
      <div class="spinner-border text-black" role="status">
        <span class="visually-hidden">ê²€ìƒ‰ ì¤‘...</span>
      </div>
      <p class="mt-2 fw-semibold text-black">ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    </div>


    {% if response_list == None %}
      {# ì´ˆê¸° ì§„ì… ì‹œ ì•„ë¬´ê²ƒë„ ì¶œë ¥í•˜ì§€ ì•ŠìŒ #}
    {% elif response_list|length == 0 %}
      <div class="alert alert-danger fw-bold mt-4" role="alert">
        ğŸ¥º ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ ì—…ë¡œë“œí•´ë³´ì„¸ìš”.
      </div>
    {% else %}
      <div class="search-result-area">
        <h5 class="mb-3 text-start fw-bold"><i class="bi bi-journal-text me-2"></i>ê²€ìƒ‰ ê²°ê³¼</h5>

        <div class="row">
          {% if image_url %}
            <div class="col-md-4 image-container">
              <div class="card mb-4">
                <div class="card-header fw-bold">ğŸ“¸ ì—…ë¡œë“œí•œ ì´ë¯¸ì§€</div>
                <img src="{{ image_url }}" class="uploaded-image" alt="Uploaded Image">
              </div>
            </div>
          {% endif %}

          <div class="{% if image_url %}col-md-8{% else %}col-md-12{% endif %}">
            <div class="accordion" id="productAccordion">
              {% for item in response_list %}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="heading-{{ forloop.counter }}">
                    <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ forloop.counter }}"
                            aria-expanded="false"
                            aria-controls="collapse-{{ forloop.counter }}">
                      {{ item.name }}
                    </button>
                  </h2>
                  <div id="collapse-{{ forloop.counter }}"
                      class="accordion-collapse collapse"
                      aria-labelledby="heading-{{ forloop.counter }}"
                      data-bs-parent="#productAccordion">
                    <div class="accordion-body text-start">
                      {% if item.brand %}<p><strong>ë¸Œëœë“œ:</strong> {{ item.brand }}</p>{% endif %}
                      {% if item.benefits %}<p><strong>ê¸°ëŒ€íš¨ê³¼:</strong> {{ item.benefits }}</p>{% endif %}
                      {% if item.how_to_take %}<p><strong>ì„­ì·¨ ë°©ë²•:</strong> {{ item.how_to_take }}</p>{% endif %}
                      {% if item.ingredients %}<p><strong>ì„±ë¶„:</strong> {{ item.ingredients }}</p>{% endif %}
                      {% if item.cautions %}<p><strong>ì£¼ì˜ì‚¬í•­:</strong> {{ item.cautions }}</p>{% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script>
  const form = document.querySelector('form');
  const loadingIndicator = document.getElementById('loading-indicator');
  form.addEventListener('submit', function () {
    loadingIndicator.style.display = 'block';
  });
  const imageInput = document.querySelector('input[type="file"]');
  imageInput?.addEventListener('change', function () {
    loadingIndicator.style.display = 'block';
  });
</script>
{% endblock %}


{% extends "layout/base.html" %}
{% load static %}

{% block title %}영양제 검색하기 · NutriWise{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/search.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block content %}
<section class="container-fluid py-4">
  <div class="main-container w-100 text-center mx-auto" >
    <div class="page-header">
      <h1><i class="fas fa-search me-3"></i><strong>건강기능식품 검색하기</strong></h1>
      <p class="lead mb-0">제품명을 입력하거나 이미지를 업로드하여 검색해보세요</p>
    </div>

    <!-- 검색 폼 -->
    <form method="post" enctype="multipart/form-data" class="d-flex justify-content-center align-items-center gap-2 mb-4 mt-4" id="searchForm">
      {% csrf_token %}
      <input type="text" name="q" class="search-input" placeholder="제품명 / 성분 / 브랜드로 검색" value="{{ request.POST.q }}" id="searchInput">

      <label class="camera-btn" title="이미지 업로드">
        <input type="file" name="image" id="image" class="d-none" accept="image/*" onchange="this.form.submit()">
        <i class="bi bi-camera"></i>
      </label>

      <button type="submit" class="btn-search">
        <i class="bi bi-search"></i>
        검색
      </button>
    </form>

    <!-- 로딩 표시 -->
    <div id="loading-indicator" class="text-center my-3" style="display: none;">
      <div class="spinner-border text-black" role="status">
        <span class="visually-hidden">검색 중...</span>
      </div>
      <p class="mt-2 fw-semibold text-black">검색 중입니다. 잠시만 기다려주세요...</p>
    </div>


    {% if response_list == None %}
      {# 초기 진입 시 아무것도 출력하지 않음 #}
    {% elif response_list|length == 0 %}
      <div class="alert alert-danger fw-bold mt-4" role="alert">
        🥺 검색 결과가 없습니다. 이미지를 다시 업로드해보세요.
      </div>
    {% else %}
      <div class="search-result-area">
        <h5 class="mb-3 text-start fw-bold"><i class="bi bi-journal-text me-2"></i>검색 결과</h5>

        <div class="row">
          {% if image_url %}
            <div class="col-md-4 image-container">
              <div class="card mb-4">
                <div class="card-header fw-bold">📸 업로드한 이미지</div>
                <img src="{{ image_url }}" class="uploaded-image" alt="Uploaded Image">
              </div>
            </div>
          {% endif %}

          <div class="{% if image_url %}col-md-8{% else %}col-md-12{% endif %}">
            <div class="accordion" id="productAccordion">
              {% for item in response_list %}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="heading-{{ forloop.counter }}">
                    <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ forloop.counter }}"
                            aria-expanded="false"
                            aria-controls="collapse-{{ forloop.counter }}">
                      {{ item.name }}
                    </button>
                  </h2>
                  <div id="collapse-{{ forloop.counter }}"
                      class="accordion-collapse collapse"
                      aria-labelledby="heading-{{ forloop.counter }}"
                      data-bs-parent="#productAccordion">
                    <div class="accordion-body text-start">
                      {% if item.brand %}<p><strong>브랜드:</strong> {{ item.brand }}</p>{% endif %}
                      {% if item.benefits %}<p><strong>기대효과:</strong> {{ item.benefits }}</p>{% endif %}
                      {% if item.how_to_take %}<p><strong>섭취 방법:</strong> {{ item.how_to_take }}</p>{% endif %}
                      {% if item.ingredients %}<p><strong>성분:</strong> {{ item.ingredients }}</p>{% endif %}
                      {% if item.cautions %}<p><strong>주의사항:</strong> {{ item.cautions }}</p>{% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script>
  const form = document.querySelector('form');
  const loadingIndicator = document.getElementById('loading-indicator');
  form.addEventListener('submit', function () {
    loadingIndicator.style.display = 'block';
  });
  const imageInput = document.querySelector('input[type="file"]');
  imageInput?.addEventListener('change', function () {
    loadingIndicator.style.display = 'block';
  });
</script>
{% endblock %}


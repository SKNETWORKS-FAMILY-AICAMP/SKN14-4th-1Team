{% extends "../layout/base.html" %}
{% load static %}
{% block style %}
    <link rel="stylesheet" href="{% static 'css/chat_recommand.css' %}">
{% endblock style %}

{% block content %}
    <div class="container-fluid py-4">
        <div class="main-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="fas fa-comments me-3"></i>맞춤형 추천 Q&A</h1>
                <p class="lead mb-0">건강기능식품에 대한 궁금증을 해결해드립니다</p>
            </div>

            <!-- Sample Questions -->
            <div class="sample-questions">
                <h6 class="mb-3"><i class="fas fa-question-circle me-2"></i>자주 묻는 질문</h6>
                <div class="row g-2">
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100 sample-question" data-question="피부에 좋은 영양제 추천해주세요">
                            <i class="fas fa-spa me-2"></i>피부에 좋은 영양제는?
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-success w-100 sample-question" data-question="피로 회복에 도움이 되는 영양제는 무엇인가요?">
                            <i class="fas fa-bolt me-2"></i>피로 회복에 도움되는 것은?
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-info w-100 sample-question" data-question="비타민D와 칼슘을 같이 먹어도 되나요?">
                            <i class="fas fa-question me-2"></i>비타민D와 칼슘 같이 복용 가능한가요?
                        </button>
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <div class="col-md-4">
                        <button class="btn btn-outline-warning w-100 sample-question" data-question="임신 중에 먹으면 안되는 영양제가 있나요?">
                            <i class="fas fa-baby me-2"></i>임신 중 주의사항은?
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-danger w-100 sample-question" data-question="오메가3의 효능과 부작용을 알려주세요">
                            <i class="fas fa-fish me-2"></i>오메가3 정보
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-secondary w-100 sample-question" data-question="종합비타민은 언제 먹는 것이 가장 좋나요?">
                            <i class="fas fa-clock me-2"></i>복용 시간 문의
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="chat-container">
                <!-- Chat History -->
                <div class="chat-history" id="chatHistory">
                    <div class="bot-message">
                        <strong><i class="fas fa-robot me-2"></i>NutriWise AI</strong><br>
                        안녕하세요! 건강기능식품에 대해 궁금한 것이 있으시면 언제든 물어보세요. 식품의약품안전처 데이터를 기반으로 정확한 정보를 제공해드리겠습니다.
                        <br> 상담을 원하시면 상담 시작을 입력하세요
                        <br> 상담을 종료하고 싶으시면 상담 종료를 입력하세요
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <strong><i class="fas fa-robot me-2"></i>NutriWise AI가 답변 중입니다...</strong>
                    <div class="typing-dots mt-2">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="chat-input-area">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="건강기능식품에 대해 궁금한 것을 물어보세요..." id="chatInput">
                        <button class="btn btn-gradient" type="button" id="sendChat">
                            <i class="fas fa-paper-plane me-2"></i>전송
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}


{% block script %}
    <script>
        // Sample responses for demonstration
        const sampleResponses = {
            "피부에 좋은 영양제 추천해주세요": "피부 건강에 도움이 되는 주요 영양소는 다음과 같습니다:\n\n• **비타민C**: 콜라겐 생성을 도와 피부 탄력과 밝기 개선\n• **비타민E**: 항산화 작용으로 피부 노화 방지\n• **아연**: 상처 치유와 여드름 개선에 도움\n• **오메가-3**: 피부 염증 완화 및 수분 유지\n• **히알루론산**: 피부 수분 공급과 보습\n\n복용 전 전문의와 상담하시길 권장합니다.",

            "피로 회복에 도움이 되는 영양제는 무엇인가요?": "피로 회복에 효과적인 영양소들입니다:\n\n• **비타민B군**: 에너지 대사 촉진 (특히 B1, B2, B6, B12)\n• **철분**: 빈혈 예방 및 산소 운반 개선\n• **마그네슘**: 근육 피로 완화 및 스트레스 해소\n• **코엔자임Q10**: 세포 에너지 생산 증진\n• **홍삼**: 면역력 강화 및 피로 개선\n• **타우린**: 간 기능 개선 및 피로 물질 제거\n\n개인의 건강 상태에 따라 적합한 제품이 다를 수 있습니다.",

            "비타민D와 칼슘을 같이 먹어도 되나요?": "네, 비타민D와 칼슘은 함께 복용하는 것이 좋습니다!\n\n**함께 복용하는 이유:**\n• 비타민D는 칼슘의 장내 흡수를 크게 증진시킵니다\n• 뼈 건강을 위해서는 두 영양소가 모두 필요합니다\n• 많은 제품이 비타민D+칼슘 복합 형태로 출시되고 있습니다\n\n**주의사항:**\n• 칼슘은 하루 500-600mg씩 나누어 복용하는 것이 흡수에 유리합니다\n• 비타민D는 지용성이므로 식후 복용을 권장합니다\n• 신장 질환이나 결석 병력이 있다면 의사와 상담 후 복용하세요",

            "임신 중에 먹으면 안되는 영양제가 있나요?": "임신 중 주의해야 할 영양제들입니다:\n\n**피해야 할 것들:**\n• **비타민A (레티놀)**: 기형아 위험 (하루 3000㎍ 이상)\n• **고용량 비타민C**: 하루 2000mg 이상 시 부작용 가능\n• **생약 성분**: 인삼, 은행잎 등 일부 한방 성분\n• **다이어트 보조제**: 가르시니아, 키토산 등\n\n**안전한 것들:**\n• **엽산**: 신경관 결손 예방 (필수)\n• **철분**: 빈혈 예방\n• **DHA**: 태아 뇌 발달\n• **칼슘**: 뼈 건강\n\n임신 중에는 반드시 산부인과 의사와 상담 후 복용하세요.",

            "오메가3의 효능과 부작용을 알려주세요": "**오메가-3의 주요 효능:**\n• 혈중 중성지질 개선\n• 혈행 개선 및 혈압 조절\n• 뇌 건강 및 기억력 개선\n• 눈 건강 (건조증 완화)\n• 염증 완화 작용\n• 심혈관 질환 예방\n\n**부작용 및 주의사항:**\n• 소화불량, 트림, 비린내\n• 혈액 응고 지연 (수술 전 중단 필요)\n• 항응고제 복용 시 상호작용 주의\n• 생선 알레르기 시 주의\n\n**올바른 복용법:**\n• 하루 1-2g (EPA+DHA 기준)\n• 식후 복용으로 흡수율 증진\n• 신선도 확인 후 복용",

            "종합비타민은 언제 먹는 것이 가장 좋나요?": "**종합비타민 복용 최적 시간:**\n\n**식후 30분 내 복용 권장**\n• 지용성 비타민(A,D,E,K) 흡수율 증진\n• 위장 자극 최소화\n• 음식과 함께 천천히 흡수\n\n**아침 식후가 가장 좋은 이유:**\n• 하루 종일 영양소 활용 가능\n• 에너지 대사에 도움\n• 수용성 비타민은 하루 내 배출되므로\n\n**주의사항:**\n• 공복 복용 시 속 쓰림 가능\n• 철분 함유 시 커피/차와 간격 두기\n• 칼슘 함유 시 하루 2회 나누어 복용\n\n개인의 생활 패턴에 맞춰 꾸준히 복용하는 것이 가장 중요합니다."
        };

        // DOM elements
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendChat');
        const chatHistory = document.getElementById('chatHistory');
        const typingIndicator = document.getElementById('typingIndicator');
        const sampleQuestions = document.querySelectorAll('.sample-question');

        // CSRF 토큰 가져오기
        function getCSRFToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, 10) === ('csrftoken=')) {
                        cookieValue = decodeURIComponent(cookie.substring(10));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Sample question click events
        sampleQuestions.forEach(button => {
            button.addEventListener('click', function() {
                const question = this.getAttribute('data-question');
                chatInput.value = question;
                sendMessage();
            });
        });

        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            chatInput.value = '';
            showTypingIndicator();

            fetch('/app/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ question: message, use_ocr: false }),
                credentials: 'same-origin'   
            })
            .then(response => {
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json();
                } else {
                    // 서버에서 HTML 등 이상 응답 시 예외 발생
                    return response.text().then(text => {
                        throw new Error("서버 오류(HTML): " + text.substring(0, 100));
                    });
                }
            })
            .then(data => {
                hideTypingIndicator();
                addMessage(data.response, 'bot');
            })
            .catch(error => {
                hideTypingIndicator();
                addMessage("죄송합니다. 서버와 연결할 수 없거나, 로그인이 만료되었습니다.", 'bot');
                console.error('Error:', error);
            });
        }

        function addMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;

            if (sender === 'user') {
                messageDiv.innerHTML = `<strong><i class="fas fa-user me-2"></i>나:</strong><br>${message}`;
            } else {
                messageDiv.innerHTML = `<strong><i class="fas fa-robot me-2"></i>NutriWise AI:</strong><br>${message.replace(/\n/g, '<br>')}`;
            }

            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }

        function getAIResponse(question) {
            // Check for exact matches first
            for (const [key, response] of Object.entries(sampleResponses)) {
                if (question.includes(key.substring(0, 10))) {
                    return response;
                }
            }

            // Keyword-based responses
            const keywords = {
                '피부': sampleResponses["피부에 좋은 영양제 추천해주세요"],
                '피로': sampleResponses["피로 회복에 도움이 되는 영양제는 무엇인가요?"],
                '비타민D': sampleResponses["비타민D와 칼슘을 같이 먹어도 되나요?"],
                '칼슘': sampleResponses["비타민D와 칼슘을 같이 먹어도 되나요?"],
                '임신': sampleResponses["임신 중에 먹으면 안되는 영양제가 있나요?"],
                '오메가': sampleResponses["오메가3의 효능과 부작용을 알려주세요"],
                '종합비타민': sampleResponses["종합비타민은 언제 먹는 것이 가장 좋나요?"],
                '복용시간': sampleResponses["종합비타민은 언제 먹는 것이 가장 좋나요?"]
            };

            for (const [keyword, response] of Object.entries(keywords)) {
                if (question.includes(keyword)) {
                    return response;
                }
            }

            // Default response
            return "죄송합니다. 해당 질문에 대한 정확한 답변을 찾지 못했습니다. 좀 더 구체적으로 질문해주시거나, 위의 샘플 질문들을 참고해주세요. 건강기능식품 관련 궁금증이 있으시면 언제든 물어보세요!";
        }

        // Auto-focus on input
        chatInput.focus();
    </script>
{% endblock script %}